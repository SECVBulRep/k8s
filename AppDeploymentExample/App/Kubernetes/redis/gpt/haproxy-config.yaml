apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: redis
data:
  haproxy.cfg: |
    global
      daemon
      maxconn 2048
      lua-load /usr/local/etc/haproxy/redis.lua
      log stdout format raw daemon

    defaults
      mode tcp
      timeout connect 5s
      timeout client 30s
      timeout server 30s
      log global

    frontend fe_redis
      bind *:6379
      default_backend be_redis

    backend be_redis
      mode tcp
      tcp-request content lua.redis_master
      server dummy 127.0.0.1:6379 send-proxy
  redis.lua: |
    core.register_init(function()
      sentinel_host = "redis-sentinel.redis.svc.cluster.local"
      sentinel_port = 26379
      sentinel_name = "mymaster"
    end)

    function redis_master(txn)
      local command = "*3\r\n$8\r\nSENTINEL\r\n$23\r\nget-master-addr-by-name\r\n$" .. sentinel_name:len() .. "\r\n" .. sentinel_name .. "\r\n"
      local sock = core.tcp()
      sock:settimeout(1000)

      if not sock:connect(sentinel_host, sentinel_port) then
        core.Alert("Sentinel connect failed")
        return
      end

      sock:send(command)
      local line = sock:receive("*l")
      if not line or not line:match("^%*2") then return end

      local len1 = tonumber(sock:receive("*l"):sub(2))
      local ip = sock:receive(len1 + 2):sub(1, len1)

      local len2 = tonumber(sock:receive("*l"):sub(2))
      local port = sock:receive(len2 + 2):sub(1, len2)
      sock:close()

      txn:set_var("txn.dst", ip)
      txn:set_var("txn.dst_port", port)
      txn:set_dst(ip)
      txn:set_dst_port(tonumber(port))
    end
